name: Auto Create PR

on:
  push:
    branches:
      - 'feature/**'
      - 'bugfix/**'

jobs:
  create-pr:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: write
      issues: read
    
    steps:
      - name: Extract Issue Number
        id: extract
        run: |
          BRANCH_NAME="${GITHUB_REF#refs/heads/}"
          echo "Branch name: $BRANCH_NAME"
          
          # feature/issue-12 ë˜ëŠ” bugfix/issue-12 í˜•íƒœì—ì„œ ìˆ«ì ì¶”ì¶œ
          if [[ $BRANCH_NAME =~ (feature|bugfix)/.*-([0-9]+) ]]; then
            ISSUE_NUM="${BASH_REMATCH[2]}"
            echo "ISSUE_NUMBER=$ISSUE_NUM" >> $GITHUB_OUTPUT
            echo "Found issue number: $ISSUE_NUM"
          else
            echo "No issue number found in branch name"
            echo "ISSUE_NUMBER=" >> $GITHUB_OUTPUT
          fi

      - name: Check if PR exists
        id: check-pr
        uses: actions/github-script@v7
        with:
          script: |
            const branchName = context.ref.replace('refs/heads/', '');
            const { data: pullRequests } = await github.rest.pulls.list({
              owner: context.repo.owner,
              repo: context.repo.repo,
              head: `${context.repo.owner}:${branchName}`,
              state: 'open'
            });
            
            const prExists = pullRequests.length > 0;
            console.log(`PR exists: ${prExists}`);
            
            // âœ… ìˆ˜ì •: GitHub Outputìœ¼ë¡œ ëª…ì‹œì  ì„¤ì •
            core.setOutput('exists', prExists ? 'true' : 'false');
            return prExists;

      - name: Create Pull Request
        if: steps.check-pr.outputs.exists == 'false'
        uses: actions/github-script@v7
        env:
          ISSUE_NUMBER: ${{ steps.extract.outputs.ISSUE_NUMBER }}
        with:
          script: |
            const issueNumber = process.env.ISSUE_NUMBER;
            const branchName = context.ref.replace('refs/heads/', '');
            
            // ê¸°ë³¸ê°’ (ì´ìŠˆ ë²ˆí˜¸ê°€ ì—†ì„ ë•Œ)
            let title = branchName;
            let body = `## ğŸ”— Related Issue
            - (ì—°ê²°ëœ ì´ìŠˆ ì—†ìŒ)
            
            ## ğŸ“ ë³€ê²½ ì‚¬í•­
            
            ## âœ… ì²´í¬ë¦¬ìŠ¤íŠ¸
            - [ ] í…ŒìŠ¤íŠ¸ ì™„ë£Œ`;
            
            if (issueNumber) {
              // ì´ìŠˆ ìƒì„¸ ê°€ì ¸ì˜¤ê¸°
              const { data: issue } = await github.rest.issues.get({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: Number(issueNumber),
              });
              
              const issueTitle = issue.title || '';
              const issueUrl = issue.html_url;
              
              // âœ… PR ì œëª©: [#ì´ìŠˆë²ˆí˜¸]
              title = `[#${issueNumber}]`;
              
              // âœ… ë³¸ë¬¸: ì´ìŠˆ ì •ë³´ + Closes + ë³€ê²½ì‚¬í•­/ì²´í¬ë¦¬ìŠ¤íŠ¸
              body = `## ğŸ”— ê´€ë ¨ ì´ìŠˆ
              #${issueNumber}
            
            Closes #${issueNumber}
            
            ## ğŸ“ ë³€ê²½ ì‚¬í•­
            
            ## âœ… ì²´í¬ë¦¬ìŠ¤íŠ¸
            - [ ] í…ŒìŠ¤íŠ¸ ì™„ë£Œ`;
            }
            
            // PR ìƒì„±
            await github.rest.pulls.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title,
              head: branchName,
              base: 'develop',
              body,
            });
            
            console.log(`PR created successfully: ${title}`);